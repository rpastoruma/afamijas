<nb-card>
    <nb-card-header>
        <div class="row float-start" >
            <h4>Listado de voluntarios</h4>
        </div>
        <button nbButton class="float-end" status="primary" (click)="openSaveVolunteerModal(true)">ALTA DE VOLUNTARIO</button>

    </nb-card-header>
    <nb-card-body>


        <br/>
        <input class="form-control" type="text" [(ngModel)]="name_surnames" name="name_surnames" placeholder="Nombre / apellidos" />

        <br/>
        <input class="form-control" type="text" [(ngModel)]="documentid" name="documentid"  placeholder="DNI / documento de identidad" />

        <br/>
        <ng-select (change)="getVolunteers()" [multiple]="false" [(ngModel)]="status" name="status" [clearable]="false">
            <ng-option value="A">VOLUNTARIOS ACTIVOS</ng-option>
            <ng-option value="D">VOLUNTARIOS DADOS DE BAJA</ng-option>
        </ng-select>

        <hr/>

        <app-custom-table
            [actions]="actions"
            [keys]="[ 'Nombre', 'DNI', 'Email', 'Teléfono']"
            [values]="volunteers"
            [align]="['left', 'left', 'left', 'left', ]"
            [filters]="[false, false, false, false]"
            [sort]="[false, false, false, false]"
            [widthToCollapse]="750"
            [withPagination]="true"
            [totalPages]="totalPages"
            [page]="page"
            [size]="size"
            [loadingE]="loadingExcel"
            [loading]="loadingPDF"
            [hasExport]="true"
            (actionSelected)="action($event)"
            (changePage)="setPage($event)"
            (filterEvent)="filter(0)"
            [isProcessing]="isProcessing"
            (exportData)="getExportData($event)"
            [showSearchButton]="true"

        >

        </app-custom-table>
    </nb-card-body>

</nb-card>




<ng-template #modalContent let-close="close">
    <div class="modal-header"> 
        <h6 *ngIf="theVolunteer.id!=''" >Modificar datos para voluntario {{theVolunteer.documentid}} - {{theVolunteer.fullname}}</h6>
        <h6 *ngIf="theVolunteer.id==''" >Alta de nuevo voluntario</h6>
        <nb-icon (click)="close()" class="sidebar-toggle" icon="close-circle-outline" title="Cerrar"></nb-icon>
    </div>

    <div  class="modal-body">
        <div>

            <div id="step1">
            Nombre: 
            <input style="margin-bottom: 15px" class="form-control" [(ngModel)]="theVolunteer.name" name="theVolunteer-name" type="text" >


            Primer apellido: 
            <input style="margin-bottom: 15px" class="form-control" [(ngModel)]="theVolunteer.surname1" name="theVolunteer-surname1" type="text" >


            Segundo apellido: 
            <input style="margin-bottom: 15px" class="form-control" [(ngModel)]="theVolunteer.surname2" name="theVolunteer-surname2" type="text" >
     

            Email: 
            <input style="margin-bottom: 15px" class="form-control" [(ngModel)]="theVolunteer.email" name="theVolunteer-email" type="text" >
 

            Teléfono: 
            <input style="margin-bottom: 15px" class="form-control" [(ngModel)]="theVolunteer.phone" name="theVolunteer-phone" type="text" >
    

            Tipo de documento de identidad: 
            <ng-select [searchable]="false" [multiple]="false" [(ngModel)]="theVolunteer.documenttype" name="theVolunteer-documenttype" [clearable]="false">
                <ng-option value="DNI">DNI</ng-option>
                <ng-option value="PASAPORTE">PASAPORTE</ng-option>
                <ng-option value="NIE">NIE</ng-option>
            </ng-select>
            <br/>

            Documento de identidad: 
            <input style="margin-bottom: 15px" class="form-control" [(ngModel)]="theVolunteer.documentid" name="theVolunteer-documentid" type="text" >

            <div style="width: 100%; text-align: right;">
            <button [disabled]="theVolunteer.name=='' || theVolunteer.surname1=='' || !validEmail(theVolunteer.email) || !validPhone(theVolunteer.phone) || !validDocumentId(theVolunteer.documentid, theVolunteer.documenttype)" nbButton status="accent" type="button" class="btn btn-outline-secondary" (click)="goStep('step2');">
                SIGUIENTE &gt;&gt;
            </button>
            </div>


            </div><div style="display: none;" id="step2">

            País: 
            <ng-select [searchable]="false" [multiple]="false" [(ngModel)]="theVolunteer.idcountry" name="theVolunteer-idcountry" (change)="getStates()" [clearable]="false">
                <ng-option *ngFor="let x of theCountries" [value]="x.id">{{x.emoji}} - {{x.name}}</ng-option>
            </ng-select>
            <br/>


            Código postal: 
            <input style="margin-bottom: 15px" class="form-control" [(ngModel)]="theVolunteer.postalcode" (change)="getStateAndCitiesByPostalCodeAndCountryId()" name="theVolunteer-postalcode" type="text" >
         

            Provincia: 
            <ng-select [searchable]="false" [multiple]="false" [(ngModel)]="theVolunteer.idstate" name="theVolunteer-idstate" (change)="theVolunteer.postalcode=''; getCities()" [clearable]="false">
                <ng-option *ngFor="let x of theStates" [value]="x.id">{{x.name}}</ng-option>
            </ng-select>
            <br/>


            Localidad: 
            <ng-select [searchable]="false" [multiple]="false" [(ngModel)]="theVolunteer.idcity" name="theVolunteer-idcity" [clearable]="false">
                <ng-option *ngFor="let x of theCities" [value]="x.id">{{x.name}}</ng-option>
            </ng-select>
            <br/>




            Dirección postal: 
            <input style="margin-bottom: 15px" class="form-control" [(ngModel)]="theVolunteer.postaladdress" name="theVolunteer-postaladdress" type="text" >
 

            <div style="margin-top:30px; width: 100%; text-align: right;">
                <button  nbButton status="accent" type="button" class="btn btn-outline-secondary" (click)="goStep('step1');">
                    &lt;&lt; ANTERIOR
                </button>
                &nbsp;&nbsp;
                <button [disabled]="!validPostalAddress(theVolunteer)" nbButton status="accent" type="button" class="btn btn-outline-secondary" (click)="goStep('step3');">
                    SIGUIENTE &gt;&gt;
                </button>
            </div>


        </div>
        
        <div style="display: none;" id="step3">

            Documento de alta:
           
            <ng-select style="margin-top: 10px;" [searchable]="false" [multiple]="false" [(ngModel)]="is_document_signed" name="is_document_signed" [clearable]="false">
                <ng-option value="SIN_FIRMA">Voy a aportar el documento SIN FIRMAR por el voluntario</ng-option>
                <ng-option value="FIRMADO">Voy a aportar el documento FIRMADO por el voluntario</ng-option>
            </ng-select>


            <div  matTooltip="Seleccionar documento de alta" class="file-upload">
                <button mat-mini-fab color="primary" class="form-control upload-btn" (click)="fileUpload.click()"><i class="fa-solid fa-paperclip"></i>&nbsp;Seleccione documento a subir</button>
                <input style="display:none" type="file" class="file-input" [accept]="requiredFileType" (change)="onFileSelected($event, 'ALTA')" #fileUpload>
                &nbsp;&nbsp;<i  (click)="cancelUpload()" *ngIf="uploadProgress" class="fa-solid fa-paperclip"></i>
            </div>       



            <div *ngIf="theVolunteer.register_document_url && theVolunteer.register_document_url!='' && !(theVolunteer.register_document_url_signed && theVolunteer.register_document_url_signed!='') " matTooltip="Documento de alta" class="file-upload">
                <a class="form-control" target="_blank" href="{{theVolunteer.register_document_url}}"><i class="fa-solid fa-paperclip"></i> Documento subido previamente (sin firmar)</a>
                <button  nbButton status="accent" type="button" class="btn btn-outline-secondary" (click)="openDocumentRegister();">
                    FIRMAR DOCUMENTO
                </button>
                <br/>
            </div>       


            <div *ngIf="theVolunteer.register_document_url_signed && theVolunteer.register_document_url_signed!=''" matTooltip="Documento de alta" class="file-upload">
                <a class="form-control" target="_blank" href="{{theVolunteer.register_document_url_signed}}"><i class="fa-solid fa-paperclip"></i> Documento subido previamente (firmado por voluntario)</a>
                <br/>
            </div>     
            
            <div style="margin-top:30px; width: 100%; text-align: right;">
                <button  nbButton status="accent" type="button" class="btn btn-outline-secondary" (click)="goStep('step2');">
                    &lt;&lt; ANTERIOR
                </button>
            </div>


            </div><!--step4-->
            
        </div>
    </div>

    <div class="modal-footer">
        <button [disabled]="isProcessing 
        || theVolunteer.name=='' || theVolunteer.surname1=='' || !validEmail(theVolunteer.email) || !validPhone(theVolunteer.phone) || !validDocumentId(theVolunteer.documentid, theVolunteer.documenttype)
        || !validPostalAddress(theVolunteer)
        || !validFee(theVolunteer)
        || !validDoc(theVolunteer)
        " 
        nbButton status="primary" type="button" class="btn btn-outline-secondary" (click)="saveVolunteer();">
            GUARDAR CAMBIOS
        </button>
    </div>
</ng-template>
  



<ng-template #modalUnregister let-close="close">
    <div class="modal-header"> 
        <h6>Confirmar baja para el voluntario {{theVolunteer.documentid}} - {{theVolunteer.fullname}}</h6>
        <nb-icon (click)="close()" class="sidebar-toggle" icon="close-circle-outline" title="Cerrar"></nb-icon>
    </div>

    <div  class="modal-body">
        <div>

            Razón de la baja: 
            <textarea class="form-control" [(ngModel)]="theVolunteer.unregister_reason" >
            </textarea>
            <br/>

            Documento de baja:
           
            <ng-select style="margin-top: 10px;" [searchable]="false" [multiple]="false" [(ngModel)]="is_document_signed" name="is_document_signed" [clearable]="false">
                <ng-option value="SIN_FIRMA">Voy a aportar el documento SIN FIRMAR por el voluntario</ng-option>
                <ng-option value="FIRMADO">Voy a aportar el documento FIRMADO por el voluntario</ng-option>
            </ng-select>


            <div  matTooltip="Seleccionar documento de baja" class="file-upload">
                <button mat-mini-fab color="primary" class="form-control upload-btn" (click)="fileUpload.click()"><i class="fa-solid fa-paperclip"></i>&nbsp;Seleccione documento a subir</button>
                <input style="display:none" type="file" class="file-input" [accept]="requiredFileType" (change)="onFileSelected($event, 'BAJA')" #fileUpload>
                &nbsp;&nbsp;<i  (click)="cancelUpload()" *ngIf="uploadProgress" class="fa-solid fa-paperclip"></i>
            </div>       



            <div *ngIf="theVolunteer.unregister_document_url && theVolunteer.unregister_document_url!=''  " matTooltip="Documento de baja" class="file-upload">
                <a class="form-control" target="_blank" href="{{theVolunteer.unregister_document_url}}"><i class="fa-solid fa-paperclip"></i> Documento subido previamente (sin firmar)</a>
                <!--button  nbButton status="accent" type="button" class="btn btn-outline-secondary" (click)="openDocumentUnRegister();">
                    FIRMAR DOCUMENTO
                </button-->

                <br/>
            </div>       


            <div *ngIf="theVolunteer.unregister_document_url_signed && theVolunteer.unregister_document_url_signed!=''" matTooltip="Documento de baja" class="file-upload">
                <a class="form-control" target="_blank" href="{{theVolunteer.unregister_document_url_signed}}"><i class="fa-solid fa-paperclip"></i> Documento subido previamente (firmado por voluntario)</a>
                <br/>
            </div>       
            
                


        </div>
    </div>

    <div class="modal-footer">
        <button  *ngIf="theVolunteer.unregister_document_url_signed && theVolunteer.unregister_document_url_signed!=''" [disabled]="isProcessing"  nbButton status="primary" type="button" class="btn btn-outline-secondary" (click)="unregisterVolunteer();">
            <span  *ngIf="theVolunteer.status=='A'">DAR DE BAJA AL VOLUNTARIO</span>
            <span *ngIf="theVolunteer.status=='D'">ACTUALIZAR BAJA AL VOLUNTARIO</span>
        </button>
    </div>
</ng-template>
  


